# Channel List Code System

## Overview

The Channel List Code system allows TV apps to authenticate and access user-specific channel lists. Each user has a unique code that links their account to their TV device.

## Environment Variables

### SUPER_ADMIN_CHANNEL_LIST_CODE
- **Purpose**: Channel list code assigned to the super admin user
- **Default**: `5T6FEP` (can be customized)
- **Usage**: Used during initial super admin creation
- **Example**: `SUPER_ADMIN_CHANNEL_LIST_CODE=5T6FEP`

### PLAYLIST_CODE (Legacy - Optional)
- **Purpose**: Global playlist access code for backward compatibility
- **Fallback**: Uses `SUPER_ADMIN_CHANNEL_LIST_CODE` if not set
- **Endpoint**: `/api/v1/channels/playlist.m3u?code=YOUR_CODE`
- **Note**: Consider using user-specific authenticated endpoints instead

## How It Works

### 1. Super Admin Initialization
When the server starts, it checks for an existing super admin user:
- If not found, creates a new super admin with credentials from environment
- Uses `SUPER_ADMIN_CHANNEL_LIST_CODE` from .env if provided
- If code not in .env, generates a random unique code
- Logs the code to console for reference

```javascript
// Example initialization
const superAdmin = new User({
  username: 'admin',
  email: 'admin@yourdomain.com',
  channelListCode: '5T6FEP', // From SUPER_ADMIN_CHANNEL_LIST_CODE
  role: 'Admin'
});
```

### 2. User Registration
When new users register:
- System automatically generates a unique 6-character channel list code
- Code is stored in user's profile
- Visible in user profile page (`/user/profile.html`)
- Can be regenerated by user (with warning about TV unlinking)

### 3. TV App Authentication
TV apps use the channel list code to authenticate:

```
GET /api/v1/user-playlist/by-code/:code/channels
GET /api/v1/user-playlist/by-code/:code/playlist.m3u
```

The TV app:
1. User enters their channel list code on TV
2. TV app makes request with the code
3. Server validates code and returns user's channel list
4. TV displays and plays channels

## API Endpoints

### User-Specific Endpoints (Recommended)

#### Get User Channels by Code
```http
GET /api/v1/user-playlist/by-code/:code/channels
```

Returns list of channels for user with matching code.

#### Get User Playlist by Code
```http
GET /api/v1/user-playlist/by-code/:code/playlist.m3u
```

Returns M3U playlist file for TV app.

### Authenticated Endpoints

#### Get My Channels
```http
GET /api/v1/user-playlist/me/channels
Headers: X-Session-Id: <session-id>
```

#### Get My Playlist
```http
GET /api/v1/user-playlist/me/playlist.m3u
Headers: X-Session-Id: <session-id>
```

### Legacy Global Endpoint

#### Global Playlist (Legacy)
```http
GET /api/v1/channels/playlist.m3u?code=<code>
```

Uses `PLAYLIST_CODE` or falls back to `SUPER_ADMIN_CHANNEL_LIST_CODE`.

## User Profile Management

### Viewing Channel List Code
Users can view their code at: `/user/profile.html`

Features:
- Display current code
- Copy to clipboard button
- Regenerate code button (with warning)

### Regenerating Code
When user regenerates their code:
1. Modal warning appears about TV unlinking
2. User confirms action
3. New unique code is generated
4. Old code is invalidated
5. TV devices must re-enter new code

### Code Format
- Length: 6 characters
- Format: Uppercase alphanumeric (A-Z, 0-9)
- Example: `5T6FEP`, `A1B2C3`, `XYZ123`
- Generated using: `crypto.randomBytes(3).toString('hex').toUpperCase()`

## Security Considerations

1. **Code Privacy**: Channel list codes should be kept private (like passwords)
2. **Unique Codes**: Each user gets a unique code to prevent conflicts
3. **Code Regeneration**: Users can regenerate if code is compromised
4. **No Expiration**: Codes don't expire but can be manually regenerated
5. **Rate Limiting**: Consider implementing rate limiting on code-based endpoints

## Setup Instructions

### Initial Setup
1. Set super admin credentials in `.env`:
   ```env
   SUPER_ADMIN_USERNAME=admin
   SUPER_ADMIN_PASSWORD=YourSecurePassword123!
   SUPER_ADMIN_EMAIL=admin@yourdomain.com
   SUPER_ADMIN_CHANNEL_LIST_CODE=5T6FEP
   ```

2. Start server - super admin is created automatically
3. Log in at `/admin/` with super admin credentials
4. View your channel list code in admin profile

### For New Users
1. Register at `/user/register.html`
2. Log in at `/user/login.html`
3. Go to profile at `/user/channels.html` â†’ Profile
4. Find your channel list code
5. Enter code in TV app

## Migration from Old System

If you were using `PLAYLIST_CODE`:

1. Add `SUPER_ADMIN_CHANNEL_LIST_CODE` to `.env`:
   ```env
   SUPER_ADMIN_CHANNEL_LIST_CODE=5T6FEP  # Your old PLAYLIST_CODE value
   ```

2. Optional: Keep `PLAYLIST_CODE` for backward compatibility:
   ```env
   PLAYLIST_CODE=5T6FEP  # Legacy support
   ```

3. Update TV apps to use new per-user code endpoints
4. Gradually phase out global `PLAYLIST_CODE` endpoint

## Troubleshooting

### Code Not Working
1. Check code is entered correctly (6 characters, case-sensitive)
2. Verify user account is active
3. Check server logs for authentication errors

### Super Admin Code Not Set
1. Check `.env` file has `SUPER_ADMIN_CHANNEL_LIST_CODE`
2. Restart server to apply changes
3. Check console logs for super admin initialization

### Code Conflicts
- System automatically generates unique codes
- If conflict occurs, code regeneration will create new unique code
- Manual codes from environment should be unique

## Future Enhancements

Potential improvements:
- Code expiration with renewal
- Multiple codes per user (for different devices)
- Code usage analytics
- Code-based access control (specific channels per code)
- QR code generation for easy TV setup
