<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self' 'unsafe-inline' 'unsafe-eval';
        connect-src 'self' https: http: blob: data: ws: wss:;
        font-src 'self' data:;
        frame-src 'self';
        img-src 'self' data: https: http:;
        media-src 'self' blob: data: https: http:;
        script-src 'self' 'unsafe-inline' 'unsafe-eval';
        style-src 'self' 'unsafe-inline';
        worker-src 'self' blob:">
    <title>My Profile - FireVision IPTV</title>
    <!-- AdminLTE 3 / Bootstrap 4 -->
    <link rel="stylesheet" href="/vendor/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/vendor/@fortawesome/fontawesome-free/css/all.min.css">
    <link rel="stylesheet" href="/vendor/admin-lte/dist/css/adminlte.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
        .profile-view {
            max-width: 1200px;
        }

        .profile-header {
            margin-bottom: 2rem;
        }

        .profile-picture-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 2rem;
        }

        .profile-picture-wrapper {
            position: relative;
            width: 150px;
            height: 150px;
            margin-bottom: 1rem;
        }

        .profile-picture {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #3b82f6;
            background: #f3f4f6;
        }

        .profile-picture-placeholder {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: white;
            font-weight: bold;
            border: 4px solid #3b82f6;
        }

        .profile-picture-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .profile-section {
            background: white;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .profile-section h2 {
            margin-top: 0;
            margin-bottom: 1.5rem;
            color: #1f2937;
            font-size: 1.5rem;
            border-bottom: 2px solid #3b82f6;
            padding-bottom: 0.5rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #374151;
        }

        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group input[type="password"] {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 1rem;
        }

        .form-group input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-group input:disabled {
            background: #f3f4f6;
            cursor: not-allowed;
        }

        .playlist-code-display {
            background: #f0f9ff;
            border: 2px solid #3b82f6;
            border-radius: 0.5rem;
            padding: 1.5rem;
            text-align: center;
        }

        .playlist-code {
            font-size: 2rem;
            font-weight: bold;
            letter-spacing: 0.3rem;
            color: #1e40af;
            margin: 0.5rem 0;
        }

        .btn-group {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }

        .info-card {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .info-card strong {
            color: #1e40af;
        }

        input[type="file"] {
            display: none;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="hold-transition sidebar-mini layout-fixed">
    <!-- Dashboard Screen -->
    <div id="dashboardScreen" class="screen">
        <div class="wrapper">
            <!-- Navbar (injected by navbar.js) -->
            <div id="navbar-placeholder"></div>
            
            <!-- Sidebar (injected by sidebar.js) -->
            <div id="sidebar-placeholder"></div>

            <!-- Content Wrapper -->
            <div class="content-wrapper">
                <section class="content-header">
                    <div class="container-fluid">
                        <div class="row mb-2">
                            <div class="col-sm-6"><h1>My Profile</h1></div>
                            <div class="col-sm-6 text-right"><p class="subtitle mb-0">Manage your account settings and preferences</p></div>
                        </div>
                    </div>
                </section>
                <section class="content">
                    <div class="container-fluid">
                        <!-- Profile Picture Section -->
                        <div class="profile-section">
                            <h2>Profile Picture</h2>
                            <div class="profile-picture-section">
                                <div class="profile-picture-wrapper">
                                    <img id="profilePicture" class="profile-picture hidden" alt="Profile Picture">
                                    <div id="profilePicturePlaceholder" class="profile-picture-placeholder">
                                        <span id="profileInitials">U</span>
                                    </div>
                                </div>
                                <div class="profile-picture-actions">
                                    <input type="file" id="profilePictureInput" accept="image/jpeg,image/jpg,image/png,image/gif">
                                    <button class="btn btn-primary" onclick="document.getElementById('profilePictureInput').click()">
                                        Upload Photo
                                    </button>
                                    <button id="deleteProfilePictureBtn" class="btn btn-danger hidden">
                                        Delete Photo
                                    </button>
                                </div>
                                <p style="color: #6b7280; font-size: 0.875rem; margin-top: 0.5rem;">
                                    Max file size: 5MB. Allowed formats: JPG, PNG, GIF
                                </p>
                            </div>
                        </div>

                        <!-- Basic Information Section -->
                        <div class="profile-section">
                            <h2>Basic Information</h2>
                            <form id="profileForm">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="username">Username</label>
                                        <input type="text" id="username" required minlength="3">
                                    </div>
                                    <div class="form-group">
                                        <label for="email">Email</label>
                                        <input type="email" id="email" required>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="role">Role</label>
                                        <input type="text" id="role" disabled>
                                    </div>
                                    <div class="form-group">
                                        <label for="memberSince">Member Since</label>
                                        <input type="text" id="memberSince" disabled>
                                    </div>
                                </div>
                                <div class="btn-group">
                                    <button type="submit" class="btn btn-primary">Save Changes</button>
                                </div>
                            </form>
                        </div>

                        <!-- Playlist Code Section -->
                        <div class="profile-section">
                            <h2>Your Playlist Code</h2>
                            <div class="info-card">
                                <p><strong>Your unique playlist code:</strong> Use this code to access your personalized channel list in the FireVision IPTV app.</p>
                            </div>
                            <div class="playlist-code-display">
                                <p style="margin: 0; color: #6b7280;">Playlist Code</p>
                                <div class="playlist-code" id="playlistCode">------</div>
                                <button class="btn btn-secondary" onclick="copyPlaylistCode()">ðŸ“‹ Copy Code</button>
                            </div>
                        </div>

                        <!-- Password Change Section -->
                        <div class="profile-section">
                            <h2>Change Password</h2>
                            <form id="passwordForm">
                                <div class="form-group">
                                    <label for="currentPassword">Current Password</label>
                                    <input type="password" id="currentPassword" required minlength="6">
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="newPassword">New Password</label>
                                        <input type="password" id="newPassword" required minlength="6">
                                    </div>
                                    <div class="form-group">
                                        <label for="confirmPassword">Confirm New Password</label>
                                        <input type="password" id="confirmPassword" required minlength="6">
                                    </div>
                                </div>
                                <div class="btn-group">
                                    <button type="submit" class="btn btn-primary">Change Password</button>
                                </div>
                            </form>
                        </div>

                        <!-- Channel Assignment Section (for regular users) -->
                        <div id="userChannelsSection" class="profile-section hidden">
                            <h2>My Assigned Channels</h2>
                            <div class="info-card">
                                <p><strong>Total Channels:</strong> <span id="assignedChannelsCount">0</span></p>
                            </div>
                            <p style="color: #6b7280;">Contact your administrator to manage your channel assignments.</p>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/vendor/jquery/dist/jquery.min.js"></script>
    <script src="/vendor/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/vendor/admin-lte/dist/js/adminlte.min.js"></script>
    <!-- Common UI Components -->
    <script src="navbar.js"></script>
    <script src="sidebar.js"></script>
    <!-- Page Scripts -->
    <script src="common.js"></script>
    <script>
        // Re-using common.js variables
        let currentUser = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            // Use common.js checkAuth
            currentUser = await checkAuth();
            if (currentUser) {
                showDashboard(currentUser, 'profile');
                loadUserProfile();
            }
        });

        // Load user profile
        function loadUserProfile() {
            // Sidebar is updated by showDashboard -> updateSidebar in common.js
            // But we need to update the profile page specific fields

            document.getElementById('username').value = currentUser.username || '';
            document.getElementById('email').value = currentUser.email || '';
            document.getElementById('role').value = currentUser.role || '';
            document.getElementById('playlistCode').textContent = currentUser.playlistCode || '------';

            if (currentUser.createdAt) {
                const date = new Date(currentUser.createdAt);
                document.getElementById('memberSince').value = date.toLocaleDateString();
            }

            // Set profile picture or initials
            if (currentUser.profilePicture) {
                document.getElementById('profilePicture').src = API_BASE + currentUser.profilePicture;
                document.getElementById('profilePicture').classList.remove('hidden');
                document.getElementById('profilePicturePlaceholder').classList.add('hidden');
                document.getElementById('deleteProfilePictureBtn').classList.remove('hidden');
            } else {
                const initials = currentUser.username ? currentUser.username.substring(0, 2).toUpperCase() : 'U';
                document.getElementById('profileInitials').textContent = initials;
            }

            // Show channel count for regular users
            if (currentUser.role !== 'Admin' && currentUser.channels) {
                document.getElementById('userChannelsSection').classList.remove('hidden');
                document.getElementById('assignedChannelsCount').textContent = currentUser.channels.length;
            }
        }

        // Handle profile form submission
        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const username = document.getElementById('username').value;
            const email = document.getElementById('email').value;
            const sessionId = getSessionId();

            try {
                const response = await fetch(`${API_BASE}/api/v1/auth/profile`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Session-Id': sessionId
                    },
                    body: JSON.stringify({ username, email })
                });

                const data = await response.json();

                if (data.success) {
                    showToast('Profile updated successfully!');
                    currentUser = data.user;
                    loadUserProfile();
                    // Also update sidebar
                    updateSidebar(currentUser, 'profile');
                } else {
                    showToast(data.error || 'Failed to update profile');
                }
            } catch (error) {
                console.error('Error updating profile:', error);
                showToast('Failed to update profile');
            }
        });

        // Handle password form submission
        document.getElementById('passwordForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const sessionId = getSessionId();

            if (newPassword !== confirmPassword) {
                showToast('New passwords do not match!');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/v1/auth/change-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Session-Id': sessionId
                    },
                    body: JSON.stringify({ currentPassword, newPassword })
                });

                const data = await response.json();

                if (data.success) {
                    showToast('Password changed successfully!');
                    document.getElementById('passwordForm').reset();
                } else {
                    showToast(data.error || 'Failed to change password');
                }
            } catch (error) {
                console.error('Error changing password:', error);
                showToast('Failed to change password');
            }
        });

        // Handle profile picture upload
        document.getElementById('profilePictureInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const sessionId = getSessionId();

            // Validate file size (5MB)
            if (file.size > 5 * 1024 * 1024) {
                showToast('File size must be less than 5MB');
                return;
            }

            const formData = new FormData();
            formData.append('profilePicture', file);

            try {
                const response = await fetch(`${API_BASE}/api/v1/auth/profile-picture`, {
                    method: 'POST',
                    headers: {
                        'X-Session-Id': sessionId
                    },
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    showToast('Profile picture uploaded successfully!');
                    currentUser.profilePicture = data.profilePicture;

                    // Update both profile page and sidebar
                    document.getElementById('profilePicture').src = API_BASE + data.profilePicture;
                    document.getElementById('profilePicture').classList.remove('hidden');
                    document.getElementById('profilePicturePlaceholder').classList.add('hidden');
                    document.getElementById('deleteProfilePictureBtn').classList.remove('hidden');

                    updateSidebar(currentUser, 'profile');
                } else {
                    showToast(data.error || 'Failed to upload profile picture');
                }
            } catch (error) {
                console.error('Error uploading profile picture:', error);
                showToast('Failed to upload profile picture');
            }

            // Reset input
            e.target.value = '';
        });

        // Handle profile picture deletion
        document.getElementById('deleteProfilePictureBtn').addEventListener('click', async () => {
            if (!confirm('Are you sure you want to delete your profile picture?')) {
                return;
            }
            const sessionId = getSessionId();

            try {
                const response = await fetch(`${API_BASE}/api/v1/auth/profile-picture`, {
                    method: 'DELETE',
                    headers: {
                        'X-Session-Id': sessionId
                    }
                });

                const data = await response.json();

                if (data.success) {
                    showToast('Profile picture deleted successfully!');
                    currentUser.profilePicture = null;

                    document.getElementById('profilePicture').classList.add('hidden');
                    document.getElementById('profilePicturePlaceholder').classList.remove('hidden');
                    document.getElementById('deleteProfilePictureBtn').classList.add('hidden');

                    const initials = currentUser.username ? currentUser.username.substring(0, 2).toUpperCase() : 'U';
                    document.getElementById('profileInitials').textContent = initials;

                    updateSidebar(currentUser, 'profile');
                } else {
                    showToast(data.error || 'Failed to delete profile picture');
                }
            } catch (error) {
                console.error('Error deleting profile picture:', error);
                showToast('Failed to delete profile picture');
            }
        });

        // Copy playlist code
        function copyPlaylistCode() {
            const code = document.getElementById('playlistCode').textContent;
            navigator.clipboard.writeText(code).then(() => {
                showToast('Playlist code copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy:', err);
                showToast('Failed to copy playlist code');
            });
        }
    </script>
</body>
</html>
